"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8764],{1114:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/simple-e25ecaf3eb4b87aa296c2d1625182bd3.png"},2787:e=>{e.exports=JSON.parse('{"permalink":"/river-docs/blog/python-thread","source":"@site/blog/2025-03-28/stop-using-python-thread.md","title":"Python thread: deep dive","description":"Modern computers are designed to handle multitasking, enabling you to run multiple programs simultaneously. But have you ever wondered how computers manage this complexity?","date":"2025-03-28T00:00:00.000Z","tags":[{"inline":true,"label":"python","permalink":"/river-docs/blog/tags/python"}],"readingTime":5.41,"hasTruncateMarker":true,"authors":[{"name":"Thanh-Giang (River) Tan Nguyen","title":"Software and bioinformatics engineer","url":"https://www.facebook.com/nttg8100","page":{"permalink":"/river-docs/blog/authors/river"},"email":"nttg8100@gmail.com","socials":{"linkedin":"https://www.linkedin.com/in/thanh-giang-tan-nguyen-761b28190/","github":"https://github.com/nttg8100"},"imageURL":"https://avatars.githubusercontent.com/u/64969412?v=4","key":"river"}],"frontMatter":{"slug":"python-thread","title":"Python thread: deep dive","authors":["river"],"tags":["python"]},"unlisted":false,"prevItem":{"title":"SSH remote tunnel","permalink":"/river-docs/blog/ssh-remote-tunnel"},"nextItem":{"title":"Single Node Slurm Setup","permalink":"/river-docs/blog/single-node-slurm-setup"}}')},3204:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/thread-f88d2e2dde98ebd8ded80062690cb4eb.png"},5443:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/process_by_htop-a8992f582881779b2f1b11225f0aae5a.png"},5524:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>c,frontMatter:()=>a,metadata:()=>s,toc:()=>h});var s=t(2787),r=t(4848),i=t(8453);const a={slug:"python-thread",title:"Python thread: deep dive",authors:["river"],tags:["python"]},o=void 0,d={authorsImageUrls:[void 0]},h=[{value:"What Is a Process in Computing?",id:"what-is-a-process-in-computing",level:2},{value:"Thread in python",id:"thread-in-python",level:2},{value:"What is GIL and how thread in python work ?",id:"what-is-gil-and-how-thread-in-python-work-",level:2},{value:"Simple process with thread in python",id:"simple-process-with-thread-in-python",level:2},{value:"Simple program",id:"simple-program",level:3},{value:"Multiple threads",id:"multiple-threads",level:3},{value:"Number of cpus and number of threads ?",id:"number-of-cpus-and-number-of-threads-",level:3},{value:"Bump! When you use threads with cpus tasks ?",id:"bump-when-you-use-threads-with-cpus-tasks-",level:3}];function l(e){const n={admonition:"admonition",br:"br",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Modern computers are designed to handle multitasking, enabling you to run multiple programs simultaneously. But have you ever wondered how computers manage this complexity?"}),"\n",(0,r.jsx)(n.p,{children:"In programming, Python is one of the most popular languages, and it supports multitasking through multiple processes and threads. However, Python has a unique feature that might lead to inefficient usage if not understood properly. Let\u2019s dive in and explore."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.img,{alt:"Processes in Computer",src:t(5443).A+"",width:"1314",height:"373"}),(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Figure 1:"})," A system monitor displaying process IDs (PIDs), user ownership, and resource consumption (e.g., memory and CPU)."]}),"\n",(0,r.jsx)(n.h2,{id:"what-is-a-process-in-computing",children:"What Is a Process in Computing?"}),"\n",(0,r.jsxs)(n.p,{children:["A process is an instance of a program being executed by a computer. It includes the program's code, data, and allocated system resources. Each process operates ",(0,r.jsx)(n.strong,{children:"independently"})," in its own memory space and can spawn multiple threads for concurrent execution."]}),"\n",(0,r.jsxs)(n.p,{children:["The operating system is responsible for managing processes, enabling them to communicate, ",(0,r.jsx)(n.strong,{children:"schedule CPU time"}),", and ",(0,r.jsx)(n.strong,{children:"share resources"})," efficiently."]}),"\n",(0,r.jsx)(n.h2,{id:"thread-in-python",children:"Thread in python"}),"\n",(0,r.jsx)(n.p,{children:"In Python, a thread runs within a single process and is managed by that process. A single process can run multiple threads, and these threads share computing\nresources such as CPU and memory. However, due to Python\u2019s Global Interpreter Lock (GIL), threads are restricted to executing on a single CPU core at a time,\neven if multiple CPU cores are available."}),"\n",(0,r.jsxs)(n.admonition,{type:"info",children:[(0,r.jsx)(n.p,{children:"What, why and how python requires GIL ?"}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The Global Interpreter Lock (GIL) is a mechanism in CPython that ensures only one thread executes Python bytecode at a time, even on multi-core processors."}),"\n",(0,r.jsx)(n.li,{children:"It prevents race conditions in memory management but limits true parallel execution for CPU-bound tasks. To achieve real parallelism, multiprocessing should be used instead of threading."}),"\n"]})]}),"\n",(0,r.jsx)(n.h2,{id:"what-is-gil-and-how-thread-in-python-work-",children:"What is GIL and how thread in python work ?"}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"This is the proof of concept for the python3 lower than 3.13. From python 3.13, the GIL can be disabled, with evenly higher performance with cpu-bound tasks while sharing the same resource (memory,etc)"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.strong,{children:"Global Interpreter Lock (GIL)"})," is a mechanism in Python that manages thread execution by allowing only ",(0,r.jsx)(n.strong,{children:"one thread to run at a time"}),", even on multi-core processors.\nAlthough multiple threads can be created, they do not achieve true parallelism for CPU-bound tasks due to the GIL."]}),"\n",(0,r.jsxs)(n.p,{children:["However, Python threads can still improve performance for ",(0,r.jsx)(n.strong,{children:"I/O-bound tasks"})," like downloading or uploading files because the CPU spends most of its time waiting for external resources.\nThe Python interpreter quickly ",(0,r.jsx)(n.strong,{children:"switches between threads"}),", saving and restoring their states, making it appear as if multiple threads are running simultaneously.\nIn reality, the ",(0,r.jsx)(n.strong,{children:"CPU rapidly cycles through threads"}),", ensuring that tasks that do not require significant computation feel like they are running in parallel."]}),"\n",(0,r.jsx)(n.h2,{id:"simple-process-with-thread-in-python",children:"Simple process with thread in python"}),"\n",(0,r.jsx)(n.h3,{id:"simple-program",children:"Simple program"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["A simple function in python, create 2 files as below ",(0,r.jsx)(n.code,{children:"single_worker.py"}),". Then you can duplicate the ",(0,r.jsx)(n.code,{children:"worker"})," step, it is similar in real world problem when you have IO tasks likes\ndownloading multiple files"]}),"\n",(0,r.jsxs)(n.li,{children:["Here to make it easier, I uses ",(0,r.jsx)(n.code,{children:"sleep"})," which is similar."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"download_file(<file_url_1>)\ndownload_file(<file_url_2>)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"single_worker.py"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import time\n\ndef worker(task_id, duration):\n\n    """Simulate work by sleeping for `duration` seconds."""\n    print(f"Thread-{task_id} started")\n    time.sleep(duration)\n    print(f"Thread-{task_id} finished")\n    print\n# execute\nstart_time = time.time()   \nworker(1,1)\nend_time = time.time()\nprint(f"Total execution time: {end_time - start_time:.2f} seconds")\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"sequential_worker.py"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import time\n\ndef worker(task_id, duration):\n\n    """Simulate work by sleeping for `duration` seconds."""\n    print(f"Thread-{task_id} started")\n    time.sleep(duration)\n    print(f"Thread-{task_id} finished")\n    print\n# execute\nstart_time = time.time()   \nworker(1,1)\n# duplicate\nworker(1,1)\nend_time = time.time()\nprint(f"Total execution time: {end_time - start_time:.2f} seconds")\n'})}),"\n",(0,r.jsx)(n.p,{children:"Run and test the time to executes"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"python3 single_worker.py\npython3 sequential_worker.py\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Simple program",src:t(1114).A+"",width:"880",height:"207"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Figure 2:"})," Execute the simple programs"]}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["For these functions, it is bad practice run them sequentially. You may automatically to use the ",(0,r.jsx)(n.code,{children:"loop"}),", it reduces number of lines in script,\nbut it takes your times while you can do it ",(0,r.jsx)(n.strong,{children:"much more better"})]}),"\n"]})}),"\n",(0,r.jsx)(n.h3,{id:"multiple-threads",children:"Multiple threads"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Create the file with content below, name it with ",(0,r.jsx)(n.code,{children:"multiple_thread.py"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import sys\nimport threading\nimport time\n\ndef worker(task_id, duration):\n    """Simulate work by sleeping for `duration` seconds."""\n    print(f"Thread-{task_id} started")\n    time.sleep(duration)\n    print(f"Thread-{task_id} finished")\n\ndef run_threads(num_threads, duration):\n    """Create and start multiple threads."""\n    threads = []\n    \n    start_time = time.time()\n    \n    for i in range(num_threads):\n        thread = threading.Thread(target=worker, args=(i, duration))\n        threads.append(thread)\n        thread.start()\n    \n    for thread in threads:\n        thread.join()  # Wait for all threads to finish\n    \n    end_time = time.time()\n    print(f"Total execution time: {end_time - start_time:.2f} seconds")\n\nif __name__ == "__main__":   \n    run_threads(sys.argv[1], 1)\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Run with threads"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"python3 multiple_thread.py <number of threads>\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"2 threads",src:t(3204).A+"",width:"880",height:"575"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Figure 3:"})," Multiple threads that you don't need to wait them sequentially"]}),"\n",(0,r.jsx)(n.h3,{id:"number-of-cpus-and-number-of-threads-",children:"Number of cpus and number of threads ?"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"It\u2019s useful to see how multiple threads can improve execution time, but the performance gain does not depend on the number of CPUs.\nI ran the program with 1000 threads, and the results showed that for non-CPU-bound tasks, using many threads is fine\u2014but excessive threads should be used with caution."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Even with more threads, they still need to share resources like internet bandwidth, and switching between threads adds overhead.\nAs a result, the execution time was 1.23s instead of 1s, showing that too many threads can slow things down."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"In general, for CPU-bound tasks, the number of threads should match the number of CPUs.\nHowever, for I/O-bound tasks like network requests, you can experiment with more threads to maximize efficiency.\nInstead of waiting 1000 seconds, the task completed in 1.23s\u2014a significant speedup! \ud83d\ude80"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"1000 threads",src:t(5942).A+"",width:"880",height:"575"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Figure 3:"})," 1000 threads in 1.23s"]}),"\n",(0,r.jsx)(n.h3,{id:"bump-when-you-use-threads-with-cpus-tasks-",children:"Bump! When you use threads with cpus tasks ?"}),"\n",(0,r.jsxs)(n.p,{children:["It does not reduces time to execute. Because it requires process to use a cpu to compute. Overall, it should not be used in cpu-bound tasks.\nCreate a file with content as below, name it with ",(0,r.jsx)(n.code,{children:"cpu_thread.py"}),"."]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"Avoid using threads for CPU-bound tasks, as they often increase execution time without providing linear performance improvements."})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import threading\nimport time\nimport sys\n\ndef cpu_task(n):\n    """Simulate a CPU-bound task by performing heavy computations."""\n    print(f"Thread-{n} started")\n    count = 0\n    for _ in range(10**7):  # Simulate CPU-intensive work\n        count += 1\n    print(f"Thread-{n} finished")\n\ndef run_threads(num_threads):\n    """Create and start multiple CPU-bound threads."""\n    threads = []\n    \n    start_time = time.time()\n    \n    for i in range(num_threads):\n        thread = threading.Thread(target=cpu_task, args=(i,))\n        threads.append(thread)\n        thread.start()\n    \n    for thread in threads:\n        thread.join()  # Wait for all threads to finish\n    \n    end_time = time.time()\n    print(f"Total execution time: {end_time - start_time:.2f} seconds")\n\nif __name__ == "__main__":\n    run_threads(int(sys.argv[1]))\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"cpu thread",src:t(9365).A+"",width:"640",height:"691"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Figure 4:"})," Use threads are crazy in python with cpu bound tasks"]})]})}function c(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},5942:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/1k_threads-318ee9c311aaf32edaf3ac717124b037.png"},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var s=t(6540);const r={},i=s.createContext(r);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(i.Provider,{value:n},e.children)}},9365:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/cpu_thread-18cee598d0feb6f8b97b4848c1855fca.png"}}]);