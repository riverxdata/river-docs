"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[712],{564:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/slurm-e2bd62c31ed705955e53c1a6cbfc917f.svg"},781:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/node_grafana-1be3b4d9f0352987567947a207197a5a.png"},958:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"high-performance-computing/how-to-build-slurm-scalable-using-ansible/deployment","title":"Deployment","description":"Ansible introduction","source":"@site/docs/3.high-performance-computing/4.how-to-build-slurm-scalable-using-ansible/2.deployment.md","sourceDirName":"3.high-performance-computing/4.how-to-build-slurm-scalable-using-ansible","slug":"/high-performance-computing/how-to-build-slurm-scalable-using-ansible/deployment","permalink":"/river-docs/docs/high-performance-computing/how-to-build-slurm-scalable-using-ansible/deployment","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Overview","permalink":"/river-docs/docs/high-performance-computing/how-to-build-slurm-scalable-using-ansible/overview"},"next":{"title":"Administration","permalink":"/river-docs/docs/high-performance-computing/how-to-build-slurm-scalable-using-ansible/administration"}}');var i=n(4848),t=n(8453);const l={},o="Deployment",a={},c=[{value:"Ansible introduction",id:"ansible-introduction",level:2},{value:"Overview on notebook",id:"overview-on-notebook",level:2},{value:"Install required python packages",id:"install-required-python-packages",level:2},{value:"Alert system via Slack",id:"alert-system-via-slack",level:2},{value:"Prepare Inventory for Hosts",id:"prepare-inventory-for-hosts",level:2},{value:"Run playbook for Cluster",id:"run-playbook-for-cluster",level:2},{value:"Run playbook for User",id:"run-playbook-for-user",level:2},{value:"Monitor system",id:"monitor-system",level:2},{value:"Node metrics",id:"node-metrics",level:3},{value:"Slurm metrics",id:"slurm-metrics",level:3},{value:"Developer",id:"developer",level:2}];function d(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"deployment",children:"Deployment"})}),"\n",(0,i.jsx)(s.h2,{id:"ansible-introduction",children:"Ansible introduction"}),"\n",(0,i.jsx)(s.p,{children:"To understand Ansible in brief, watch this"}),"\n",(0,i.jsx)("div",{style:{position:"relative",paddingBottom:"56.25%",height:0,overflow:"hidden",maxWidth:"100%",background:"#000"},children:(0,i.jsx)("iframe",{src:"https://www.youtube.com/embed/xRMPKQweySE",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%"}})}),"\n",(0,i.jsx)(s.h2,{id:"overview-on-notebook",children:"Overview on notebook"}),"\n",(0,i.jsx)(s.p,{children:"Compared with previous set up on a single node cluster, this ansible is not only set up slurm with seperated between the master and workers nodes,\nbut also install the"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Monitor Server:"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"geerlingguy.docker: Docker container"}),"\n",(0,i.jsx)(s.li,{children:"Prometheus: Monitoring metrics collection"}),"\n",(0,i.jsx)(s.li,{children:"Alertmanager: Alerts to Slack channel with specific rules (e.g., down node)"}),"\n",(0,i.jsx)(s.li,{children:"Grafana: Dashboard for monitoring usage"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Slurm HPC:"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Common Roles:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"geerlingguy.docker (only for sudo group users)"}),"\n",(0,i.jsx)(s.li,{children:"alertmanager"}),"\n",(0,i.jsx)(s.li,{children:"grafana"}),"\n",(0,i.jsx)(s.li,{children:"prometheus-slurm-exporter"}),"\n",(0,i.jsx)(s.li,{children:"prometheus-node-exporter"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Specific Nodes:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Controller Node:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"slurm-master: Controller and login node"}),"\n",(0,i.jsx)(s.li,{children:"rsyslog-server: Syslog server controller"}),"\n",(0,i.jsx)(s.li,{children:"nfs-server: Network file system to share files across clusters"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Worker Nodes:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"slurm-worker: Computing nodes"}),"\n",(0,i.jsx)(s.li,{children:"rsyslog-client: Syslog client worker"}),"\n",(0,i.jsx)(s.li,{children:"nfs-client: Access files on the controller"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["To set up the cluster with many steps, IT automation tools likes Ansible, Puppet, Terraform are used to handle it automatically.\nIn RiverXData ecosystem, we set up the Slurm cluster using ",(0,i.jsx)(s.a,{href:"https://docs.ansible.com/",children:(0,i.jsx)(s.strong,{children:"Ansible"})}),", to set up the slurm cluster, follow the documentation at this ",(0,i.jsx)(s.a,{href:"https://github.com/riverxdata/river-slurm/tree/main",children:(0,i.jsx)(s.strong,{children:"RIVERXDATA SLURM"})})]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"cluster",src:n(564).A+""})})}),"\n",(0,i.jsx)(s.h2,{id:"install-required-python-packages",children:"Install required python packages"}),"\n",(0,i.jsx)(s.p,{children:"Clone the repo"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"git clone https://github.com/riverxdata/river-slurm.git -b 1.0.0\n"})}),"\n",(0,i.jsx)(s.p,{children:"Install ansible, other required python packages and relative roles"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# to show agruments\n# bash scripts/setup.sh\nbash scripts/setup.sh 24.04 false\n"})}),"\n",(0,i.jsx)(s.h2,{id:"alert-system-via-slack",children:"Alert system via Slack"}),"\n",(0,i.jsx)(s.admonition,{type:"info",children:(0,i.jsxs)(s.p,{children:["In an industrial setting, even small teams benefit from effective communication through chat applications. Slack is a widely-used app that facilitates this. It offers features such as custom webhooks, which are useful for infrastructure monitoring notifications. For more information, visit the ",(0,i.jsx)(s.a,{href:"https://api.slack.com/quickstart",children:(0,i.jsx)(s.strong,{children:"Slack API Quickstart"})}),"."]})}),"\n",(0,i.jsx)(s.p,{children:"You should have a slack workspace, where you already created a specific channel for this notifications"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 1"}),": Create an app"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"cluster",src:n(1324).A+"",width:"1093",height:"731"})})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 2"}),": Add app to your channel, configure it with the webhook features"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"cluster",src:n(3578).A+"",width:"1093",height:"1115"})})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 3"}),": Click to incomming webhooks and activate it"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"cluster",src:n(3745).A+"",width:"1093",height:"1115"})})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 4"}),": Try with api to check the app work"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"cluster",src:n(5880).A+"",width:"1093",height:"1115"})})}),"\n",(0,i.jsx)(s.admonition,{type:"warning",children:(0,i.jsx)(s.p,{children:"To check for api setting, try with this on your terminal"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"curl -X POST -H 'Content-type: application/json' --data '{\"text\":\"Hello, World!\"}' <API>\n"})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Step 5"}),": See how it run in real case\nApp is added in channel"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"cluster",src:n(3974).A+"",width:"1059",height:"420"})})}),"\n",(0,i.jsx)(s.p,{children:"For detail, check at grafana dashboard"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"cluster",src:n(2011).A+"",width:"2560",height:"1283"})})}),"\n",(0,i.jsx)(s.h2,{id:"prepare-inventory-for-hosts",children:"Prepare Inventory for Hosts"}),"\n",(0,i.jsxs)(s.p,{children:["For the password, it should be configured using ",(0,i.jsx)(s.a,{href:"https://docs.ansible.com/ansible/2.8/user_guide/vault.html",children:(0,i.jsx)(s.strong,{children:"ansible vault"})})," with encrypted, decrypted secret variables\nCopy the example ",(0,i.jsx)(s.code,{children:"hosts.example"})," file in the inventories directory. In this file, define the user and host for your setup:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"[slurm_master]\ncontroller-01 ansible_host=192.168.58.10\n\n[slurm_worker]\nworker-01 ansible_host=192.168.58.11\n\n[slurm:children]\nslurm_master\nslurm_worker\n\n[all:vars]\nansible_user=vagrant\nslurm_password=<password for Munge to authenticate via symmetric key>\nslurm_account_db_pass=<slurm account database password>\n"})}),"\n",(0,i.jsx)(s.p,{children:"Optional parameters:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"default_password=<default password for users in the cluster; first login will enforce a password change>\nusers=<comma-separated list of new usernames>\nslack_api_url=<Slack webhook URL for cluster status notifications>\nslack_channel=<Slack channel for notifications>\nadmin_user =<Grafana admin user>\nadmin_password=<Grafana admin password>\n"})}),"\n",(0,i.jsx)(s.h2,{id:"run-playbook-for-cluster",children:"Run playbook for Cluster"}),"\n",(0,i.jsx)(s.p,{children:"To set up on your cluster, ensure that the remote nodes can log in without a password. Run the following command:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"ansible-playbook -i inventories/hosts river_cluster.yml\n"})}),"\n",(0,i.jsxs)(s.p,{children:["If a password is required, add the ",(0,i.jsx)(s.code,{children:"--ask-become-pass"})," flag and run:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"ansible-playbook -i inventories/hosts river_cluster.yml --ask-become-pass\n"})}),"\n",(0,i.jsx)(s.h2,{id:"run-playbook-for-user",children:"Run playbook for User"}),"\n",(0,i.jsx)(s.p,{children:"To set up users on the cluster, use Ansible. NIS is less secure and other methods are not well supported for Ubuntu. Simply run the following command to add users:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"ansible-playbook -i inventories/hosts river_users.yml\n"})}),"\n",(0,i.jsx)(s.p,{children:"Validate setup"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# get cluster info\nsinfo\n# get current job\nsqueue\n# submit interactive\nsrun --pty bash\n"})}),"\n",(0,i.jsx)(s.p,{children:"By default, the grafana runs on the master node on port 3000. With users and password are set on the inventories\nTo access the dashboard, while you do not access the master node directly, use ssh"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"ssh -N -L 3001:localhost:3000 <user name>@<host name or IP address>\n"})}),"\n",(0,i.jsx)(s.h2,{id:"monitor-system",children:"Monitor system"}),"\n",(0,i.jsx)(s.h3,{id:"node-metrics",children:"Node metrics"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"Node metrics",src:n(781).A+"",width:"2559",height:"1293"})})}),"\n",(0,i.jsx)(s.h3,{id:"slurm-metrics",children:"Slurm metrics"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"Slurm metrics",src:n(2522).A+"",width:"2559",height:"1293"})})}),"\n",(0,i.jsx)(s.h2,{id:"developer",children:"Developer"}),"\n",(0,i.jsx)(s.p,{children:"Install vagrant and relative provider, for Ubuntu, it automatically install the libvirt and run the ansible playbook"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"bash scripts/setup.sh 24.04 true\n"})})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1324:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/create_app-5f947edfa49ffbdf36fe676be2c07ec2.png"},2011:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/grafana_down-e246254641a25b9312cfa3800cc99bb1.png"},2522:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/slurm_grafana-d38acb72e98a3d7cd3a9fa5fbfcfd88e.png"},3578:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/config_1-9d474b122b801e342837ef04c9f5830e.png"},3745:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/config_2-00d5027252e91dfd879cc3493c03dec6.png"},3974:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/resume_node-7e21b97ade95598e247fe80abd75ce91.png"},5880:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/config_3-d3746310237e6ce3e41c3e02e9659122.png"},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>o});var r=n(6540);const i={},t=r.createContext(i);function l(e){const s=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(t.Provider,{value:s},e.children)}}}]);