"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[8855],{47(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/hpc_2-93055d91a4fae86ccf8700bc6e0cd2a8.svg"},552(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/config_2-00d5027252e91dfd879cc3493c03dec6.png"},1476(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/node_grafana-1be3b4d9f0352987567947a207197a5a.png"},3513(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/create_app-5f947edfa49ffbdf36fe676be2c07ec2.png"},4957(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/resume_node-7e21b97ade95598e247fe80abd75ce91.png"},5827(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/config_1-9d474b122b801e342837ef04c9f5830e.png"},5926(e){e.exports=JSON.parse('{"permalink":"/river-docs/blog/how-to-build-slurm-hpc-part-2","source":"@site/blog/2026-01/2026-01-12.md","title":"Building a Slurm HPC Cluster (Part 2) - Scaling to Production with Ansible","description":"In Part 1, we learned the fundamentals by building a single-node Slurm cluster. Now it\'s time to scale up to a production-ready, multi-node cluster with automated deployment, monitoring, and alerting.","date":"2026-01-12T00:00:00.000Z","tags":[{"inline":true,"label":"slurm","permalink":"/river-docs/blog/tags/slurm"},{"inline":true,"label":"hpc","permalink":"/river-docs/blog/tags/hpc"},{"inline":true,"label":"ansible","permalink":"/river-docs/blog/tags/ansible"},{"inline":true,"label":"automation","permalink":"/river-docs/blog/tags/automation"},{"inline":true,"label":"devops","permalink":"/river-docs/blog/tags/devops"}],"readingTime":8.86,"hasTruncateMarker":true,"authors":[{"name":"Thanh-Giang Tan Nguyen","title":"Founder at RIVER","url":"https://www.facebook.com/nttg8100","page":{"permalink":"/river-docs/blog/authors/river"},"email":"nttg8100@gmail.com","socials":{"linkedin":"https://www.linkedin.com/in/thanh-giang-tan-nguyen-761b28190/","github":"https://github.com/nttg8100"},"imageURL":"https://avatars.githubusercontent.com/u/64969412?v=4","key":"river"}],"frontMatter":{"slug":"how-to-build-slurm-hpc-part-2","title":"Building a Slurm HPC Cluster (Part 2) - Scaling to Production with Ansible","authors":["river"],"tags":["slurm","hpc","ansible","automation","devops"],"image":"./imgs/hpc_2.svg"},"unlisted":false,"prevItem":{"title":"Building a Slurm HPC Cluster (Part 3) - Administration and Best Practices","permalink":"/river-docs/blog/how-to-build-slurm-hpc-part-3"},"nextItem":{"title":"Building a Slurm HPC Cluster (Part 1) - Single Node Setup and Fundamentals","permalink":"/river-docs/blog/how-to-build-slurm-hpc-part-1"}}')},6041(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/grafana-7dace9efecdbf46b14c5e25c659f17ad.png"},6934(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/small_HPC-ee51275c1193ebc8a4abe061b1fafbc6.jpg"},7049(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/slurm_grafana-d38acb72e98a3d7cd3a9fa5fbfcfd88e.png"},8153(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});var r=s(5926),i=s(4848),t=s(8453);const l={slug:"how-to-build-slurm-hpc-part-2",title:"Building a Slurm HPC Cluster (Part 2) - Scaling to Production with Ansible",authors:["river"],tags:["slurm","hpc","ansible","automation","devops"],image:"./imgs/hpc_2.svg"},a=void 0,o={image:s(47).A,authorsImageUrls:[void 0]},c=[{value:"Series Overview",id:"series-overview",level:2},{value:"Why Ansible for HPC Clusters?",id:"why-ansible-for-hpc-clusters",level:2},{value:"What is Ansible? (Quick Primer)",id:"what-is-ansible-quick-primer",level:3},{value:"Production Cluster Architecture",id:"production-cluster-architecture",level:2},{value:"Head Node (Controller + Login)",id:"head-node-controller--login",level:3},{value:"Compute Nodes",id:"compute-nodes",level:3},{value:"Shared Storage (NFS)",id:"shared-storage-nfs",level:3},{value:"Monitoring Stack",id:"monitoring-stack",level:3},{value:"Setting Up the RiverXData Slurm Cluster",id:"setting-up-the-riverxdata-slurm-cluster",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Step 1: Clone the Repository",id:"step-1-clone-the-repository",level:3},{value:"Step 2: Install Ansible and Dependencies",id:"step-2-install-ansible-and-dependencies",level:3},{value:"Step 3: Set Up Slack Alerts",id:"step-3-set-up-slack-alerts",level:3},{value:"Create a Slack App",id:"create-a-slack-app",level:4},{value:"Enable Incoming Webhooks",id:"enable-incoming-webhooks",level:4},{value:"Test Your Webhook",id:"test-your-webhook",level:4},{value:"Step 4: Configure Your Inventory",id:"step-4-configure-your-inventory",level:3},{value:"Optional Parameters",id:"optional-parameters",level:4},{value:"Step 5: Deploy the Cluster",id:"step-5-deploy-the-cluster",level:3},{value:"Step 6: Add Users",id:"step-6-add-users",level:3},{value:"Step 7: Verify the Setup",id:"step-7-verify-the-setup",level:3},{value:"Step 8: Access Grafana Dashboards",id:"step-8-access-grafana-dashboards",level:3},{value:"Node Metrics Dashboard",id:"node-metrics-dashboard",level:4},{value:"Slurm Metrics Dashboard",id:"slurm-metrics-dashboard",level:4},{value:"What About Alerts?",id:"what-about-alerts",level:3},{value:"Testing Your Cluster",id:"testing-your-cluster",level:2},{value:"Test 1: Simple Job",id:"test-1-simple-job",level:3},{value:"Test 2: Multi-node Job",id:"test-2-multi-node-job",level:3},{value:"Test 3: Interactive Session",id:"test-3-interactive-session",level:3},{value:"Test 4: Batch Job",id:"test-4-batch-job",level:3},{value:"Test 5: Resource Limits",id:"test-5-resource-limits",level:3},{value:"Test 6: Accounting",id:"test-6-accounting",level:3},{value:"Architecture Diagram",id:"architecture-diagram",level:2},{value:"For Developers: Local Testing with Vagrant",id:"for-developers-local-testing-with-vagrant",level:2},{value:"Key Takeaways",id:"key-takeaways",level:2},{value:"Resources",id:"resources",level:2},{value:"Contact",id:"contact",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.a,{href:"/blog/how-to-build-slurm-hpc-part-1",children:"Part 1"}),", we learned the fundamentals by building a single-node Slurm cluster. Now it's time to scale up to a production-ready, multi-node cluster with automated deployment, monitoring, and alerting."]}),"\n",(0,i.jsx)(n.p,{children:"In this post, we'll use Ansible to automate the entire deployment process, making it reproducible and maintainable."}),"\n",(0,i.jsx)(n.h2,{id:"series-overview",children:"Series Overview"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"/blog/how-to-build-slurm-hpc-part-1",children:"Part 1"})}),": Introduction, Architecture, and Single Node Setup"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Part 2 (This Post)"}),": Scaling to Production with Ansible"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.a,{href:"/blog/how-to-build-slurm-hpc-part-3",children:"Part 3"})}),": Administration and Best Practices"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"why-ansible-for-hpc-clusters",children:"Why Ansible for HPC Clusters?"}),"\n",(0,i.jsx)(n.p,{children:"Moving from a single-node setup to a multi-node production cluster involves:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Configuring multiple machines identically"}),"\n",(0,i.jsx)(n.li,{children:"Managing dependencies and installation order"}),"\n",(0,i.jsx)(n.li,{children:"Keeping configurations synchronized"}),"\n",(0,i.jsx)(n.li,{children:"Handling user management across nodes"}),"\n",(0,i.jsx)(n.li,{children:"Setting up monitoring and logging infrastructure"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Doing this manually is error-prone and time-consuming. Infrastructure automation tools like Ansible, Puppet, or Terraform solve this problem. We chose ",(0,i.jsx)(n.strong,{children:"Ansible"})," because:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Agentless"}),": No software to install on managed nodes"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Declarative"}),": Describe the desired state, not the steps"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Idempotent"}),": Safe to run multiple times"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"YAML-based"}),": Easy to read and version control"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Large ecosystem"}),": Many pre-built roles available"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"what-is-ansible-quick-primer",children:"What is Ansible? (Quick Primer)"}),"\n",(0,i.jsx)(n.p,{children:"If you're new to Ansible, watch this excellent 100-second introduction:"}),"\n",(0,i.jsx)("div",{style:{position:"relative",paddingBottom:"56.25%",height:0,overflow:"hidden",maxWidth:"100%",background:"#000"},children:(0,i.jsx)("iframe",{src:"https://www.youtube.com/embed/xRMPKQweySE",frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%"}})}),"\n",(0,i.jsx)(n.h2,{id:"production-cluster-architecture",children:"Production Cluster Architecture"}),"\n",(0,i.jsx)(n.p,{children:"Our production setup includes these components:"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Small HPC Cluster",src:s(6934).A+"",width:"1386",height:"933"})})}),"\n",(0,i.jsxs)(n.p,{children:["Source: ",(0,i.jsx)(n.a,{href:"https://cs.phenikaa-uni.edu.vn/vi/post/gioi-thieu/co-so-vat-chat/he-thong-tinh-toan-hieu-nang-cao-phenikaa-hpc",children:"https://cs.phenikaa-uni.edu.vn/vi/post/gioi-thieu/co-so-vat-chat/he-thong-tinh-toan-hieu-nang-cao-phenikaa-hpc"})]}),"\n",(0,i.jsx)(n.h3,{id:"head-node-controller--login",children:"Head Node (Controller + Login)"}),"\n",(0,i.jsx)(n.p,{children:"The head node manages the cluster and provides user access:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"slurmctld"}),": Job scheduling and resource management"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"slurmdbd"}),": Accounting database"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"NFS Server"}),": Shares directories to compute nodes"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Prometheus"}),": Metrics collection"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Grafana"}),": Monitoring dashboards"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Alertmanager"}),": Slack notifications"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"compute-nodes",children:"Compute Nodes"}),"\n",(0,i.jsx)(n.p,{children:"Worker nodes that execute jobs:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"slurmd"}),": Job execution daemon"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"NFS Client"}),": Mounts shared storage"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Node Exporter"}),": Exposes system metrics"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Slurm Exporter"}),": Exposes Slurm-specific metrics"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"shared-storage-nfs",children:"Shared Storage (NFS)"}),"\n",(0,i.jsx)(n.p,{children:"NFS provides unified file system access across all nodes:"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"NFS Architecture",src:s(8814).A+"",width:"1200",height:"675"})})}),"\n",(0,i.jsxs)(n.p,{children:["Source: ",(0,i.jsx)(n.a,{href:"https://thuanbui.me/cai-dat-nfs-server-va-nfs-client-tren-ubuntu-22-04/",children:"https://thuanbui.me/cai-dat-nfs-server-va-nfs-client-tren-ubuntu-22-04/"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/home"}),": User home directories (fast SSD/NVMe storage)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/mnt/data"}),": Large datasets (high-capacity HDD)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"monitoring-stack",children:"Monitoring Stack"}),"\n",(0,i.jsx)(n.p,{children:"Complete observability for your cluster:"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Grafana Dashboard",src:s(6041).A+"",width:"1168",height:"863"})})}),"\n",(0,i.jsxs)(n.p,{children:["Source: ",(0,i.jsx)(n.a,{href:"https://swsmith.cc/posts/grafana-slurm.html",children:"https://swsmith.cc/posts/grafana-slurm.html"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Prometheus"}),": Time-series metrics database"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Grafana"}),": Beautiful dashboards for visualization"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Alertmanager"}),": Sends alerts to Slack when issues occur"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Node Exporter"}),": System-level metrics (CPU, memory, disk)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Slurm Exporter"}),": Slurm-specific metrics (jobs, partitions, nodes)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"setting-up-the-riverxdata-slurm-cluster",children:"Setting Up the RiverXData Slurm Cluster"}),"\n",(0,i.jsx)(n.p,{children:"We've created a comprehensive Ansible playbook that automates everything. Let's get started!"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Slurm Deployment Architecture",src:s(9255).A+""})})}),"\n",(0,i.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Multiple Ubuntu 20.04 or 24.04 machines (or VMs)"}),"\n",(0,i.jsx)(n.li,{children:"SSH access to all nodes"}),"\n",(0,i.jsx)(n.li,{children:"Sudo privileges on all nodes"}),"\n",(0,i.jsx)(n.li,{children:"A Slack workspace (for alerts)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"step-1-clone-the-repository",children:"Step 1: Clone the Repository"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/riverxdata/river-slurm.git -b 1.0.0\ncd river-slurm\n"})}),"\n",(0,i.jsx)(n.h3,{id:"step-2-install-ansible-and-dependencies",children:"Step 2: Install Ansible and Dependencies"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Ubuntu 24.04, without Vagrant\nbash scripts/setup.sh 24.04 false\n\n# For Ubuntu 20.04\nbash scripts/setup.sh 20.04 false\n\n# For developers: Install with Vagrant support\nbash scripts/setup.sh 24.04 true\n"})}),"\n",(0,i.jsx)(n.p,{children:"This script installs:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Ansible and required Python packages"}),"\n",(0,i.jsx)(n.li,{children:"Community Ansible collections"}),"\n",(0,i.jsx)(n.li,{children:"Galaxy roles (geerlingguy.docker, etc.)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"step-3-set-up-slack-alerts",children:"Step 3: Set Up Slack Alerts"}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"In production environments, even small teams benefit from proactive monitoring. Slack is perfect for this - you'll get notifications when nodes go down, jobs fail, or resources run low."})}),"\n",(0,i.jsx)(n.h4,{id:"create-a-slack-app",children:"Create a Slack App"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Go to ",(0,i.jsx)(n.a,{href:"https://api.slack.com/apps",children:"Slack API"})," and create a new app"]}),"\n",(0,i.jsx)(n.li,{children:'Choose "From scratch"'}),"\n",(0,i.jsx)(n.li,{children:'Name it (e.g., "Slurm Cluster Monitor")'}),"\n",(0,i.jsx)(n.li,{children:"Select your workspace"}),"\n"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Create Slack App",src:s(3513).A+"",width:"1093",height:"731"})})}),"\n",(0,i.jsx)(n.h4,{id:"enable-incoming-webhooks",children:"Enable Incoming Webhooks"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:'Navigate to "Incoming Webhooks" in your app settings'}),"\n",(0,i.jsx)(n.li,{children:"Activate incoming webhooks"}),"\n",(0,i.jsx)(n.li,{children:'Click "Add New Webhook to Workspace"'}),"\n",(0,i.jsxs)(n.li,{children:["Select the channel for notifications (e.g., ",(0,i.jsx)(n.code,{children:"#cluster-alerts"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Copy the webhook URL"}),"\n"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Slack Config Step 1",src:s(5827).A+"",width:"1093",height:"1115"})})}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Slack Config Step 2",src:s(552).A+"",width:"1093",height:"1115"})})}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Slack Config Step 3",src:s(8417).A+"",width:"1093",height:"1115"})})}),"\n",(0,i.jsx)(n.h4,{id:"test-your-webhook",children:"Test Your Webhook"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -X POST -H 'Content-type: application/json' \\\n  --data '{\"text\":\"Hello from Slurm cluster!\"}' \\\n  https://hooks.slack.com/services/YOUR/WEBHOOK/URL\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see the message appear in your Slack channel!"}),"\n",(0,i.jsx)(n.h3,{id:"step-4-configure-your-inventory",children:"Step 4: Configure Your Inventory"}),"\n",(0,i.jsxs)(n.p,{children:["Create ",(0,i.jsx)(n.code,{children:"inventories/hosts"})," (or copy from ",(0,i.jsx)(n.code,{children:"inventories/hosts.example"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ini",children:"[slurm_master]\ncontroller-01 ansible_host=192.168.58.10\n\n[slurm_worker]\nworker-01 ansible_host=192.168.58.11\nworker-02 ansible_host=192.168.58.12\n\n[slurm:children]\nslurm_master\nslurm_worker\n\n[all:vars]\nansible_user=your_username\nslurm_password=secure_munge_password\nslurm_account_db_pass=secure_db_password\nslack_api_url=https://hooks.slack.com/services/YOUR/WEBHOOK/URL\nslack_channel=#cluster-alerts\nadmin_user=admin\nadmin_password=secure_grafana_password\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"warning",children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Security Best Practice"}),": Use ",(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/user_guide/vault.html",children:"Ansible Vault"})," to encrypt sensitive variables like passwords and API keys."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Create encrypted vault\nansible-vault create inventories/vault.yml\n\n# Or encrypt existing file\nansible-vault encrypt inventories/hosts\n"})})]}),"\n",(0,i.jsx)(n.h4,{id:"optional-parameters",children:"Optional Parameters"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ini",children:"default_password=temporary_user_password  # Forces change on first login\nusers=alice,bob,charlie                   # Comma-separated list\n"})}),"\n",(0,i.jsx)(n.h3,{id:"step-5-deploy-the-cluster",children:"Step 5: Deploy the Cluster"}),"\n",(0,i.jsx)(n.p,{children:"Now for the magic moment - deploy your entire cluster with one command!"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# If you have passwordless sudo configured\nansible-playbook -i inventories/hosts river_cluster.yml\n\n# If you need to enter sudo password\nansible-playbook -i inventories/hosts river_cluster.yml --ask-become-pass\n"})}),"\n",(0,i.jsx)(n.p,{children:"What this playbook does:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Prepares all nodes"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Updates packages"}),"\n",(0,i.jsx)(n.li,{children:"Installs dependencies"}),"\n",(0,i.jsx)(n.li,{children:"Configures firewalls"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Sets up the controller"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Installs slurmctld and slurmdbd"}),"\n",(0,i.jsx)(n.li,{children:"Configures MariaDB for accounting"}),"\n",(0,i.jsx)(n.li,{children:"Sets up NFS server"}),"\n",(0,i.jsx)(n.li,{children:"Installs monitoring stack"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Configures compute nodes"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Installs slurmd"}),"\n",(0,i.jsx)(n.li,{children:"Mounts NFS shares"}),"\n",(0,i.jsx)(n.li,{children:"Configures metrics exporters"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Deploys monitoring"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Prometheus for metrics collection"}),"\n",(0,i.jsx)(n.li,{children:"Grafana with pre-configured dashboards"}),"\n",(0,i.jsx)(n.li,{children:"Alertmanager with Slack integration"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Synchronizes configurations"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Copies slurm.conf to all nodes"}),"\n",(0,i.jsx)(n.li,{children:"Sets up Munge authentication"}),"\n",(0,i.jsx)(n.li,{children:"Configures log aggregation"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"step-6-add-users",children:"Step 6: Add Users"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ansible-playbook -i inventories/hosts river_users.yml\n"})}),"\n",(0,i.jsx)(n.p,{children:"This creates Linux users on all nodes with:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Synchronized UID/GID across nodes"}),"\n",(0,i.jsx)(n.li,{children:"Home directories on shared NFS"}),"\n",(0,i.jsx)(n.li,{children:"Slurm accounting associations"}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note on User Management"}),": For production, consider integrating with LDAP or Active Directory. However, NIS and LDAP setup can be complex on Ubuntu. Our Ansible approach provides a simpler alternative that works well for small to medium clusters."]})}),"\n",(0,i.jsx)(n.h3,{id:"step-7-verify-the-setup",children:"Step 7: Verify the Setup"}),"\n",(0,i.jsx)(n.p,{children:"SSH into the controller node and run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Check cluster status\nsinfo\n\n# Expected output:\n# PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST\n# compute*     up   infinite      2   idle worker-01,worker-02\n\n# View job queue\nsqueue\n\n# Submit a test job\nsrun --nodes=1 --ntasks=1 hostname\n\n# Check accounting\nsacct\n\n# View cluster configuration\nscontrol show config | head -20\n"})}),"\n",(0,i.jsx)(n.h3,{id:"step-8-access-grafana-dashboards",children:"Step 8: Access Grafana Dashboards"}),"\n",(0,i.jsx)(n.p,{children:"Grafana runs on the controller node at port 3000. To access it securely from your local machine:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Create SSH tunnel\nssh -N -L 3001:localhost:3000 your_user@controller_ip\n\n# Now open in browser: http://localhost:3001\n# Login: admin / your_grafana_password\n"})}),"\n",(0,i.jsx)(n.p,{children:"You'll see pre-configured dashboards showing:"}),"\n",(0,i.jsx)(n.h4,{id:"node-metrics-dashboard",children:"Node Metrics Dashboard"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CPU usage per node"}),"\n",(0,i.jsx)(n.li,{children:"Memory utilization"}),"\n",(0,i.jsx)(n.li,{children:"Disk I/O"}),"\n",(0,i.jsx)(n.li,{children:"Network traffic"}),"\n",(0,i.jsx)(n.li,{children:"System load"}),"\n"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Node Grafana Dashboard",src:s(1476).A+"",width:"2559",height:"1293"})})}),"\n",(0,i.jsx)(n.h4,{id:"slurm-metrics-dashboard",children:"Slurm Metrics Dashboard"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Active jobs"}),"\n",(0,i.jsx)(n.li,{children:"Job queue length"}),"\n",(0,i.jsx)(n.li,{children:"Node states (idle, allocated, down)"}),"\n",(0,i.jsx)(n.li,{children:"CPU allocation"}),"\n",(0,i.jsx)(n.li,{children:"Memory usage"}),"\n",(0,i.jsx)(n.li,{children:"Job completion rates"}),"\n"]}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Slurm Grafana Dashboard",src:s(7049).A+"",width:"2559",height:"1293"})})}),"\n",(0,i.jsx)(n.h3,{id:"what-about-alerts",children:"What About Alerts?"}),"\n",(0,i.jsx)(n.p,{children:"Alertmanager is configured to send Slack notifications for:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Node down"}),": When a compute node becomes unresponsive"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Node resumed"}),": When a node comes back online"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"High CPU usage"}),": Sustained high CPU across cluster"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"High memory usage"}),": Memory pressure warnings"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Disk space low"}),": Storage running out"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Example alert in Slack when a node goes down:"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Node Resume Alert",src:s(4957).A+"",width:"1059",height:"420"})})}),"\n",(0,i.jsx)(n.p,{children:"For detailed information, check the Grafana dashboard:"}),"\n",(0,i.jsx)("figure",{markdown:"span",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Grafana Node Down",src:s(9654).A+"",width:"2560",height:"1283"})})}),"\n",(0,i.jsx)(n.h2,{id:"testing-your-cluster",children:"Testing Your Cluster"}),"\n",(0,i.jsx)(n.p,{children:"Let's run some tests to ensure everything works:"}),"\n",(0,i.jsx)(n.h3,{id:"test-1-simple-job",children:"Test 1: Simple Job"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"srun hostname\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-2-multi-node-job",children:"Test 2: Multi-node Job"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"srun --nodes=2 --ntasks=2 hostname\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-3-interactive-session",children:"Test 3: Interactive Session"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"srun --nodes=1 --cpus-per-task=2 --mem=2G --pty bash\n\n# Inside the session\nhostname\nnproc\nfree -h\nexit\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-4-batch-job",children:"Test 4: Batch Job"}),"\n",(0,i.jsxs)(n.p,{children:["Create ",(0,i.jsx)(n.code,{children:"test_job.sh"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n#SBATCH --job-name=test\n#SBATCH --output=test_%j.out\n#SBATCH --error=test_%j.err\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=2\n#SBATCH --mem=1G\n#SBATCH --time=00:05:00\n\necho "Job started at $(date)"\necho "Running on node: $(hostname)"\necho "CPUs allocated: $SLURM_CPUS_PER_TASK"\necho "Memory allocated: $SLURM_MEM_PER_NODE MB"\n\n# Do some work\nsleep 60\n\necho "Job finished at $(date)"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Submit it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sbatch test_job.sh\n\n# Check status\nsqueue\n\n# When done, view output\ncat test_*.out\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-5-resource-limits",children:"Test 5: Resource Limits"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Submit job requesting more resources than available\nsrun --mem=999999 --pty bash\n\n# Should fail with:\n# srun: error: Unable to allocate resources: Requested node configuration is not available\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-6-accounting",children:"Test 6: Accounting"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# View your jobs\nsacct\n\n# Detailed accounting info\nsacct --format=JobID,JobName,User,State,Start,End,Elapsed,CPUTime,MaxRSS\n\n# Cluster usage summary\nsreport cluster utilization\n"})}),"\n",(0,i.jsx)(n.h2,{id:"architecture-diagram",children:"Architecture Diagram"}),"\n",(0,i.jsx)(n.p,{children:"Here's what you've built:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502           Users SSH to Controller           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502   Controller Node (Head)     \u2502\n    \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n    \u2502  \u2502 slurmctld              \u2502  \u2502  Job Scheduling\n    \u2502  \u2502 slurmdbd + MariaDB     \u2502  \u2502  Accounting\n    \u2502  \u2502 NFS Server             \u2502  \u2502  Shared Storage\n    \u2502  \u2502 Prometheus + Grafana   \u2502  \u2502  Monitoring\n    \u2502  \u2502 Alertmanager           \u2502  \u2502  Alerts\n    \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502                  \u2502\n    \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 worker-01\u2502       \u2502 worker-02\u2502\n    \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502       \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n    \u2502 \u2502slurmd\u2502 \u2502       \u2502 \u2502slurmd\u2502 \u2502\n    \u2502 \u2502NFS \u2191 \u2502 \u2502       \u2502 \u2502NFS \u2191 \u2502 \u2502\n    \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502       \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.h2,{id:"for-developers-local-testing-with-vagrant",children:"For Developers: Local Testing with Vagrant"}),"\n",(0,i.jsx)(n.p,{children:"If you want to test the deployment locally using VMs:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Install Vagrant with libvirt provider\nbash scripts/setup.sh 24.04 true\n\n# Create local VMs and deploy cluster\nvagrant up\n\n# SSH to controller\nvagrant ssh controller-01\n\n# Destroy VMs when done\nvagrant destroy -f\n"})}),"\n",(0,i.jsx)(n.h2,{id:"key-takeaways",children:"Key Takeaways"}),"\n",(0,i.jsx)(n.p,{children:"In this post, we've covered:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Why Automation"}),": The benefits of using Ansible for cluster management"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Production Architecture"}),": Multi-node setup with monitoring and alerting"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Slack Integration"}),": Proactive monitoring with notifications"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Automated Deployment"}),": One command to deploy the entire cluster"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Verification"}),": Testing your cluster thoroughly"]}),"\n"]}),"\n",(0,i.jsxs)(n.admonition,{type:"info",children:[(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"What's Next?"})}),(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.a,{href:"/blog/how-to-build-slurm-hpc-part-3",children:"Part 3"}),", we'll cover daily administration tasks, troubleshooting, security best practices, and advanced resource management."]})]}),"\n",(0,i.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"GitHub Repository"}),": ",(0,i.jsx)(n.a,{href:"https://github.com/riverxdata/river-slurm",children:"RiverXData Slurm Ansible"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Deployment Docs"}),": ",(0,i.jsx)(n.a,{href:"/docs/resources/high-performance-computing/how-to-build-slurm-scalable-using-ansible/deployment",children:"Scalable Slurm Deployment"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Architecture Overview"}),": ",(0,i.jsx)(n.a,{href:"/docs/resources/high-performance-computing/how-to-build-slurm-scalable-using-ansible/overview",children:"Slurm Architecture"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Ansible Documentation"}),": ",(0,i.jsx)(n.a,{href:"https://docs.ansible.com/",children:"docs.ansible.com"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"contact",children:"Contact"}),"\n",(0,i.jsxs)(n.p,{children:["Questions about the deployment? Reach out at: ",(0,i.jsx)(n.a,{href:"mailto:nttg8100@gmail.com",children:"nttg8100@gmail.com"})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.em,{children:["This is Part 2 of the RiverXData series on building Slurm HPC clusters. Continue to ",(0,i.jsx)(n.a,{href:"/blog/how-to-build-slurm-hpc-part-3",children:"Part 3"})," for administration and best practices."]})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8417(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/config_3-d3746310237e6ce3e41c3e02e9659122.png"},8453(e,n,s){s.d(n,{R:()=>l,x:()=>a});var r=s(6540);const i={},t=r.createContext(i);function l(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(t.Provider,{value:n},e.children)}},8814(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/NFS-41d4079c304dac75689e6ecdc6063d02.png"},9255(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/slurm-e2bd62c31ed705955e53c1a6cbfc917f.svg"},9654(e,n,s){s.d(n,{A:()=>r});const r=s.p+"assets/images/grafana_down-e246254641a25b9312cfa3800cc99bb1.png"}}]);