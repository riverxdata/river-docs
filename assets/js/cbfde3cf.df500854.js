"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[8781],{911(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"analysis/Testing","title":"Testing","description":"You are on your root folder of the repository, you need to test the tools instead of running them on the HPC and validate the tool configuration.","source":"@site/docs/4.analysis/2.Testing.md","sourceDirName":"4.analysis","slug":"/analysis/Testing","permalink":"/docs/analysis/Testing","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Development","permalink":"/docs/analysis/Development"},"next":{"title":"Publish","permalink":"/docs/analysis/Publish"}}');var r=t(4848),i=t(8453);const s={},a=void 0,l={},c=[{value:"Create parameters json",id:"create-parameters-json",level:2},{value:"Create the run_local command",id:"create-the-run_local-command",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["You are on your root folder of the repository, you need to test the tools instead of running them on the HPC and validate the tool configuration.\nHere we can test it easily with local environment. This section is linked with previous example repostory setup on ",(0,r.jsx)(n.a,{href:"/docs/analysis/Development",children:(0,r.jsx)(n.strong,{children:"Development"})})]}),"\n",(0,r.jsx)(n.h2,{id:"create-parameters-json",children:"Create parameters json"}),"\n",(0,r.jsxs)(n.p,{children:["The platform generates ",(0,r.jsx)(n.code,{children:"params.json"})," using your SSH credentials and injects values into shell environment variables.\nTo simulate this behavior on the HPC, you can use this as below content"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example params.json for testing:"})}),"\n",(0,r.jsxs)(n.p,{children:["Create the file ",(0,r.jsx)(n.code,{children:"tests/params.json"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "name": "Thanh-Giang Tan Nguyen 09/07/2025 11:05:01 PM",\n  "cpu": 1,\n  "memory": 2,\n  "time": 3600,\n  "tag": "4.4.2-3",\n  "profile": "",\n  "git": "valid_git_repo",\n  "bucket_name": "genomics",\n  "AWS_ACCESS_KEY_ID": "invalid",\n  "AWS_SECRET_ACCESS_KEY": "invalid",\n  "AWS_REGION_NAME": "invalid",\n  "AWS_ENDPOINT_URL": "invalid",\n  "file": "workspace/test.txt",\n  "dir": "workspace",\n  "integer": 1,\n  "number": 0.3,\n  "string": "string1",\n  "boolean": true,\n  "outdir": "batch-template-analysis"\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"create-the-run_local-command",children:"Create the run_local command"}),"\n",(0,r.jsxs)(n.p,{children:["Create the ",(0,r.jsx)(n.code,{children:"tests/run_local.sh"})," bash script, it is similar to the script that will be generated on the HPC.\nInstead running under the job, it will run at your local environment. With pixi, it ensure the consitency between your local environment and HPC"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'###########################################################################################################################\n# simulate job directory\nexport BASEDIR=$PWD\nexport RIVER_HOME=$PWD/work\nexport job_id="job_id"\nmkdir -p $RIVER_HOME/jobs/job_id\ncp $PWD/tests/params.json $RIVER_HOME/jobs/job_id/params.json\ncd $RIVER_HOME/jobs/job_id\n###########################################################################################################################\n# Simulate flow of job script\necho "Checking requirements"\nwhich micromamba || (echo "micromamba not found. Please install micromamba and try again." && exit 1)\n\n# Install dependencies\nif ! micromamba env list | grep -q \'river\'; then\n    micromamba create -y -n river python=3.12 conda-forge::singularity=3.8.6 bioconda::nextflow jq git -y\nfi\n\n# Activate environment\neval "$(micromamba shell hook --shell bash)"\nmicromamba activate river\n\n# Setup networking\nexport PORT=$(python -c "import socket; s=socket.socket(); s.bind((\'\',0)); print(s.getsockname()[1]); s.close()")\necho $PORT > $RIVER_HOME/jobs/job_id/job.port\necho $(hostname) > $RIVER_HOME/jobs/job_id/job.host\n\n# Load parameters and clone repository\nwhile IFS== read -r key value; do\n   export "$key=$value"\ndone < <(jq -r \'to_entries|map("\\(.key)=\\(.value|tostring)")|.[]\' params.json)\n\ngit=$(git remote get-url origin 2>/dev/null)\nrepo_name=$(basename -s .git "$git")\nowner=$(basename "$(dirname "$git")")\nlocal_dir="$RIVER_HOME/tools/$owner/$repo_name/$tag"\n\nif [[ "$git" == *"nf-"* ]]; then\n    profiles="${profile:+singularity,$profile}"\n    profiles="${profiles:-singularity}"\n    nextflow run "$owner/$repo_name" \\\n        -r "$tag" \\\n        -c river.config \\\n        -profile "$profiles" \\\n        -process.executor slurm \\\n        -process.shell \'bash\' \\\n        --outdir "s3://$bucket_name/$outdir/job_id" \\\n        -with-report "s3://$bucket_name/$outdir/job_id/report.html" \\\n        -resume\nelse\n    bash $BASEDIR/river/main.sh\nfi\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["On HPC, it will clone tools and relative tags on the ",(0,r.jsx)(n.code,{children:"RIVER_HOME"})," location where you defined when you created SSH credential.\nThe tool is ran by creating the symlink from tool source of ",(0,r.jsx)(n.code,{children:"RIVER_HOME"})," to job working directory. On the local environment, it\nwill generate the symlink on the same repo, you should delete it to avoid commit it on the repo."]})}),"\n",(0,r.jsx)(n.p,{children:"Run the test from this"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"bash tests/run_local.sh\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For more real world example, check at ",(0,r.jsx)(n.a,{href:"/docs/case-studies/Overview",children:(0,r.jsx)(n.strong,{children:"Case studies"})})]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>s,x:()=>a});var o=t(6540);const r={},i=o.createContext(r);function s(e){const n=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);